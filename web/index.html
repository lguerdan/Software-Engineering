<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Degree Plan Visualization</title>
    <link href="style.css" rel="stylesheet" type="text/css" />
    <!-- From vis -->
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="jquery.js"></script>
    <!-- Compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css">
    <!-- Compiled and minified JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/js/materialize.min.js"></script>
</head>

<body>
    <div class="row">
        <div class="column" id="decisionPane">
           <div class="row">
            <h2>Degree Visualizer</h2>
             <form id = "degreeSelector" class="col s12"  onsubmit="">
               <div class="row">
                  <p><b>Choose Degree Plan:</b></p>
                 <div class="input-field col s12" name = "deg1">
                   <select>
                     <option value="" selected>Choose degree one</option>
                      <option value="csMajor">CS Major</option>
                      <option value="itMajor">IT Major</option>
                      <option value="musicMajor">Music Major</option>
                      <option value="mathMinor">Math Minor</option>
                      <option value="businessMinor">Business Minor</option>
                   </select>
                   <label>Degree One</label>
                 </div>
               </div>
               <div class="row">
                  <p><b>Choose Secondary Degree Plan:</b></p>
                  <div class="input-field col s12" name = "deg2">
                     <select>
                        <option value="" selected>Choose degree one</option>
                        <option value="csMajor">CS Major</option>
                        <option value="itMajor">IT Major</option>
                        <option value="musicMajor">Music Major</option>
                        <option value="mathMinor">Math Minor</option>
                        <option value="businessMinor">Business Minor</option>
                   </select>
                   <label>Degree Two</label>
                 </div>
               </div>
               <div class = "center-align">
                  <button class="btn waves-effect waves-light " type="button" onclick="getDegrees()">See Degree Plans</button>
               </div>
             </form>
           </div>
            <br>

            <p><b>Course Name:</b></p>
            <div id="courseName">Name of selected course.</div>

            <p><b>Course Description:</b></p>
            <div id="courseDescription">Description of selected course.</div>

            <p><b>Prerequisites:</b></p>
            <div id="coursePrereq">Prerequisites of selected course.</div>
        </div>
        <div class="column" id="visualizationPane">
            <!-- START OF COPIED CODE -->
            <svg width="960" height="800"></svg>
            <script>

            function getDegrees(){

               var deg1 = document.getElementById("degreeSelector").elements[1].value;
               var deg2 = document.getElementById("degreeSelector").elements[3].value;

               if(deg1 === "Choose degree one" && deg2 === "Choose degree two" ){
                  Materialize.toast('Please select at least one degree', 4000)
                  return;
               }else if(deg1 === deg2) {
                  Materialize.toast('Please select distinct degrees', 4000)
                  alert("return")
                  return;
               }

               json_request_full = json_request_base
               if(deg1 !== "Choose degree one"){
                  json_request_full += "deg1=" + deg1
               }
               alert(json_request_base)
               if(deg1 !== "Choose degree one" && deg2 !== "Choose degree two" ){
                  json_request_full += "&"
                  return;
               }
               if(deg2 !== "Choose degree two"){
                  json_request_full += "deg2=" + deg2
               }
               alert(json_request_full)

            }
            $(document).ready(function() {
               $('select').material_select();
            });
            var json_request_base = "http://evanescence.herokuapp.com/get_degree?"
            var json_request_full;





            var json_request_text = "http://evanescence.herokuapp.com/get_degree?deg1=CSMajor";
            var course_info_JSON;

                var width = 960,
                    height = 500,
                    radius = 6;


            $.getJSON(json_request_text, function(data) {
                    console.log("success");
                    //console.log(data);
                    course_info_JSON = data.CSMajor;
                })
                .done(function() {
                    console.log("second success");
                    console.log(course_info_JSON);
                    console.log(course_info_JSON.length);

                    // Create list of verticies & requirements
                    var courses = [];

                    var requirements = [];
                    var num_requirements = 0;
                    var course_tree = []; // Maybe don't use this...
                    var courses_assigned = []; // List of courses we've already assigned
                    //var temp_courses_assigned = [];
                    var courses_assigned_flag = [];
                    var num_courses_assigned = 0; // Number of courses we've already assigned
                    var temp_num_courses_assigned = 0;
                    var num_courses_per_group = [];
                    var depth = 0;
                    var found = true;
                    var no_prerecs = true;

                    for (i = 0; i < course_info_JSON.length; i++) {
                        courses[i] = {
                            "id": course_info_JSON[i].GUID,
                            "group": 1
                        };
                        for (j = 0; j < course_info_JSON[i].Prerequisites.length; j++) {
                            requirements[num_requirements + j] = {
                                "source": course_info_JSON[i].Prerequisites[j],
                                "target": course_info_JSON[i].GUID,
                                "value": 1 // Not exactly sure what this does...
                            };
                            num_requirements++;
                        }
                    }

                    // Iterate through groups (WE DON'T KNOW THE LENGTH IN ADVANCE)
                    // Loop while num_courses_assigned != num_courses_total
                    // Iterate through courses
                    // Iterate through courses' prerequisites
                    // Iterate through already assigned courses


                    // ~~~~~~~~~~~~~~~ START OF GROUP-DETERMINING CODE ~~~~~~~~~~~~~~~~~~~
                    var num_courses_fabricated = 0;
                    var num_courses_total = course_info_JSON.length;
                    console.log("num_courses_total: " + num_courses_total);

                    for (i = 0; i < num_courses_total; i++) {
                        courses_assigned_flag[i] = 0;
                    }

                    while (num_courses_assigned - num_courses_fabricated < num_courses_total && depth < 6) {
                        temp_num_courses_assigned = 0;
                        var temp_courses_assigned = [];
                        console.log("Iterating group " + depth);
                        for (i = 0; i < num_courses_total; i++) {
                            if (courses_assigned_flag[i] == 0) {
                                console.log("Looking at item " + i);
                                if (course_info_JSON[i].Prerequisites.length == 0) {
                                    console.log("NO PRERECS");
                                    found = true;
                                } else {
                                    found = true;
                                    for (j = 0; j < course_info_JSON[i].Prerequisites.length && found; j++) {
                                        found = false;
                                        console.log("pre: " + course_info_JSON[i].Prerequisites[j]);
                                        for (k = 0; k < num_courses_assigned && !found; k++) {
                                            if (courses_assigned[k].id == course_info_JSON[i].Prerequisites[j]) {
                                                console.log("MATCH FOUND");
                                                console.log("asg: " + courses_assigned[k].id);
                                                found = true;
                                            }
                                        }
                                        if (!found) {
                                            console.log("Checking for presence of " + course_info_JSON[i].Prerequisites[j] + "...");
                                            // Check if the prerequisite we're looking for is here at all
                                            for (l = 0; l < num_courses_total; l++) {
                                                if (courses[l].id == course_info_JSON[i].Prerequisites[j]) {
                                                    found = true;
                                                }
                                            }
                                            if (!found) {
                                                console.log("PREREQUISITE COMPLETELY ABSENT");
                                                num_courses_per_group[0]++;
                                                courses_assigned[num_courses_assigned] = {
                                                    id: course_info_JSON[i].Prerequisites[j],
                                                    group: 0
                                                };
                                                num_courses_fabricated++;
                                                num_courses_assigned++;
                                                found = true;
                                            } else {
                                                found = false;
                                            }
                                        }
                                    }
                                }
                                //console.log( "found == " + found );
                                if (found) {
                                    console.log("Assigning course to courses_assigned...");
                                    temp_courses_assigned[temp_num_courses_assigned] = {
                                        id: course_info_JSON[i].GUID,
                                        group: depth
                                    };
                                    temp_num_courses_assigned++;
                                    num_courses_per_group[depth]++;
                                    courses_assigned_flag[i] = 1;
                                }
                            } else {
                                console.log("Skipping item   " + i);
                            }
                        }
                        depth++;
                        console.log("temp_num_courses_assigned: " + temp_num_courses_assigned);
                        console.log("num_courses_assigned: " + num_courses_assigned);
                        console.log("num_courses_fabricated: " + num_courses_fabricated);
                        if (temp_num_courses_assigned == 0) {
                            console.log("Things are now stuck");
                            break;
                        }
                        for (i = 0; i < temp_num_courses_assigned; i++) {
                            courses_assigned[num_courses_assigned] = temp_courses_assigned[i];
                            num_courses_assigned++;

                        }
                        console.log("courses added to group " + (depth - 1) + ":");
                        console.log(temp_courses_assigned);
                        console.log("num_courses_assigned: " + num_courses_assigned);
                    }
                    // ~~~~~~~~~~~~~~~ END OF GROUP-DETERMINING CODE ~~~~~~~~~~~~~~~~~~~~~


                    console.log("courses_assigned");
                    console.log(courses_assigned);
                    //console.log( requirements );

                    var courses_not_assigned = [];
                    var counter = 0;
                    console.log("courses_not_assigned");
                    for (i = 0; i < num_courses_total; i++) {
                        if (courses_assigned_flag[i] == 0) {
                            courses_not_assigned[counter] = course_info_JSON[i];
                            counter++;
                        }
                    }
                    console.log(courses_not_assigned);
                    var faux_links = [
                        { source: "CMP_SC3050", target: "CMP_SC4520", value: 1, length: 1 },
                        { source: "CMP_SC2050", target: "CMP_SC3050", value: 1, length: 1 }
                    ];

                    // ~~~~~~~~~~~~~~~ START OF LINK-DETERMINING CODE ~~~~~~~~~~~~~~~~~~~~~
                    var num_links_total = 0;
                    for( i = 0; i < num_courses_total; i++ ) {
                        num_links_total += course_info_JSON[i].Prerequisites.length;
                    }
                    console.log("num_links_total: " + num_links_total);

                    var links = [];
                    var counter = 0;
                    var temp_length;
                    var start_depth;
                    var end_depth;
                    var temp_value;
                    for( i = 0; i < num_courses_total; i++ ) {
                        for( l = 0; l < courses_assigned.length; l++ ) {
                            if( courses_assigned[l].id == course_info_JSON[i].GUID ) {
                                end_depth = courses_assigned[l].group;
                            }
                        }
                        for( j = 0; j < course_info_JSON[i].Prerequisites.length; j++ ) {
                            for( k = 0; k < courses_assigned.length; k++ ) {
                                if( courses_assigned[k].id == course_info_JSON[i].Prerequisites[j] ) {
                                    start_depth = courses_assigned[k].group;
                                    temp_value = courses_assigned[k].group;
                                }
                            }
                            temp_length = end_depth - start_depth;
                            links[counter] = {
                                source: course_info_JSON[i].Prerequisites[j],
                                target: course_info_JSON[i].GUID,
                                length: temp_length,
                                value: temp_value
                            };
                            counter++;
                        }
                    }
                    console.log("links: ");
                    console.log(links);

                    // ~~~~~~~~~~~~~~~ END OF LINK-DETERMINING CODE ~~~~~~~~~~~~~~~~~~~~~~~

                    var revised_course_JSON = {
                        "nodes": courses_assigned,
                        "links": links
                    };

                    console.log(revised_course_JSON);

                    // ————————————————————————————————————————————————————— //
                    // CODE COPIED FROM https://bl.ocks.org/mbostock/4062045 //
                    // ————————————————————————————————————————————————————— //

                    var svg = d3.select("svg"),
                        width = +svg.attr("width"),
                        height = +svg.attr("height");

                    var color = d3.scaleOrdinal(d3.schemeCategory20);

                    var simulation = d3.forceSimulation()
                        .force("link", d3.forceLink().id(function(d) { return d.id; }))
                        .force("charge", d3.forceManyBody().strength(-60))
                        //.force("charge", function() { return -2; })
                        .force("center", d3.forceCenter(width / 2, height / 2));

                    //d3.json( revised_course_JSON, function(error, graph) {
                    //  if (error) throw error;
                    function fakeD3Load(graph) {

                        var link = svg.append("g")
                            .attr("class", "links")
                            .selectAll("line")
                            .data(graph.links)
                            .enter().append("line")
                            //.attr("stroke-width", function(d) { return Math.sqrt(d.value); })
                            .attr("x1", function(d) { return d.value * 100 + 50 })
                            .attr("x2", function(d) { return (d.value + d.length) * 100 + 50 });

                        var node = svg.append("g")
                            .attr("class", "nodes")
                            .selectAll("circle")
                            .data(graph.nodes)
                            .enter().append("circle")
                            .attr("r", 5)
                            .attr("x", function(d) { return (d.group * 200) })
                            .attr("fill", function(d) { return color(d.group); })
                            .attr("transform", function(d) { return "translate(" + (d.group * 100 + 50) + "," + 0 + ")"; })
                            .attr("charge", -300)
                            .call(d3.drag()
                                .on("start", dragstarted)
                                .on("drag", dragged)
                                .on("end", dragended));

//                        var force = d3.force();
//                            .gravity(.05)
//                            .charge(-240)
//                            .linkDistance(50)
//                            .size([width, height]);



                        node.append("title")
                            .text(function(d) { return d.id; });

                        node.append("text")
                            .text(function(d) { return d.id; });
                            //.attr("x", function(d) { return 10 })
                            //.attr("dy", ".35em")
                            //.attr("text-anchor", function(d) { return "start"; })
                            //.text(function(d) { return d.id; })
                            //.style("fill-opacity", 1e-6);

                        simulation
                            .nodes(graph.nodes)
                            .on("tick", ticked);

                        simulation.force("link")
                            .links(graph.links);
                        
                        node.on("click", function(params){
                            console.log(graph)
                           console.log(params) 
//                           d3.select(this).classed("selected");
                            var selectedIndex = params.index
                            if (graph.nodes[selectedIndex].description == undefined) {
                                var string = "We do not have this info right now"
                                $("#courseName").html(string)
                                $("#courseDescription").html(string)
                                $("#coursePrereqs").html(string)
                            }
                            else {
                                $("#courseName").html(graph.nodes[selectedIndex].title)
                                $("#courseDescription").html(graph.nodes[selectedIndex].description)
                                $("#coursePrereqs").html(graph.nodes[selectedIndex].prerequisites)
                            }
                        });

                        function ticked() {
                            link
                                //.attr("x1", function(d) { return d.source.x + 1 * 100 + 50; })
                                .attr("y1", function(d) { return d.source.y; })
                                //.attr("x2", function(d) { return d.target.x + 1 * 100 + 50; })
                                .attr("y2", function(d) { return d.target.y; });


                            node
                                //.attr("cx", function(d) { return d.x; })
                                .attr("cy", function(d) { return d.y = Math.max(radius, Math.min(height - radius, d.y)); });
                        }

                    //});
                    };

                    fakeD3Load(revised_course_JSON);

                    function dragstarted(d) {
                        if (!d3.event.active) simulation.alphaTarget(0.3).restart();
                        d.fx = d.x;
                        d.fy = d.y;
                    }

                    function dragged(d) {
                        d.fx = d3.event.x;
                        d.fy = d3.event.y;
                    }

                    function dragended(d) {
                        if (!d3.event.active) simulation.alphaTarget(0);
                        d.fx = null;
                        d.fy = null;
                    }
                    

                })
                .fail(function() {
                    console.log("error");
                })
                .always(function() {
                    console.log("complete");
                });


            // Include other scripts here...
            </script>
        </div>
    </div>
</body>

</html>